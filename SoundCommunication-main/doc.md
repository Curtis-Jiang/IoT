# 物联网大作业 —— 声波通信 文档

## 项目代码的实现逻辑

在代码实现上，进行了从python字符串到声音信号的分层处理。

### 编码

在 `src/coder.py` 文件中。

编码采用 ASCII 编码，将字符串与 0/1 数组。相互转换

### 数据包

在 `src/packager.py` 文件中。

数据包格式：12 bit 的 preamble + 16 bit 的长度变量 + 数据负载 + 奇偶校验位

打包过程：

1. 构建 preamble，即 6 个 0 和 6 个 1 的序列
2. 构建长度变量，即 16 bit 的长度变量，表示数据负载的长度
3. 构建奇偶校验位，即 1 bit 的奇偶校验位，表示数据负载的奇偶性
4. 将上述三个部分拼接在一起，得到数据包，调用调制器进行调制

> 为了避免爆鸣，我们在得到调制器的结果后，在前后均加上了若干个信号的静音

解包过程：

1. 我们有两种互相验证的寻找数据头的方法：
   1. 构建一个 preamble 调制后的信号，在时间轴上做相关性卷积计算，找到相关性最大的位置，即为数据头的位置
   2. 我们以 1/8 的信号长度划分起点，然后对每一段信号进行傅里叶变换，找到连续能解码为 000000111111 的信号段，即为数据头的位置
2. 根据数据头的位置，在 preamble 的后面 16 bit 位置，即为长度变量，读取长度变量，得到数据负载的长度
3. 根据数据负载的长度，读取数据负载，得到数据负载
4. 根据数据负载的长度，读取奇偶校验位，得到奇偶校验位
5. 根据数据负载和奇偶校验位，判断数据是否正确

### 调制

在 `src/modulator.py` 文件中。

采用 GFSK 调制。给出一个中心频率，和频率宽度，在给定的频率范围内可以调制 1-4 个 bit 的信息。

调制过程：

1. 按照单个信号包含的 bit 的数量，将数据分组
2. 对所有分组后的信号，生成频率的时间序列，0 表示低频，1 表示高频
3. 对频率的时间序列进行高斯滤波，进行平滑
4. 对频率的时间序列，进行前缀和，得到相位的时间序列
5. 使用正弦函数作用于相位的时间序列，得到最终的信号

解调过程：

> 我们这里假设信号已经在正确的地方被划分，即我们可以得到信号的时间起止点，因此只需要考虑单个信号的解调。

1. 对每个单个的信号进行傅里叶变换，得到信号的频谱图
2. 利用频率功率的最高峰，以及在一个频率范围内的功率密度总和，两者综合判断发送端最可能的频率
3. 根据得到的频率解码到 0/1 数组

## 实验结果及分析

### 实验环境

我们将生成的 wav 文件发送到手机上，在手机上播放录音；在电脑上，我们使用麦克风录音，然后进行解码。

### 结果

我们将收到的 wav 一并附在 result 文件夹下。

### 距离对传输性能影响

> 调整发送端与接收端之间的距离（50cm、100cm、150cm、200cm），分别测量不同距离下传输的比特错误率

| 距离   | 50cm | 100cm | 150cm | 200cm |
| ------ | ---- | ----- | ----- | ----- |
| 正确率 | 100% | 100%  | 58%   | 76%   |

原因分析：距离越远，声音越小，杂音相对越大。

### 抗干扰能力

> 在 3 种不同强度的噪声环境下（安静环境、人声说话环境、大音量音乐嘈杂环境），分别测量不同噪声环境下传输比特错误率


| 噪音   | 安静 | 一般 | 大音乐 |
| ------ | ---- | ---- | ------ |
| 正确率 | 100% | 78%  | 98%    |

大音乐可能并不能带来比较显著的频率分布变化，而人声说话会带来比较固定的频率的能量变化，从而显著影响正确率。

#### 遮挡影响

> 固定发送端和接收端之间距离为约 100cm，在收发设备之间分别使用自定义物体（一件）、书籍、人体遮挡，分别测量不同遮挡下传输的比特错误率。

| 噪音   | 没有遮挡 | 果冻 | 书籍 | 人体 |
| ------ | -------- | ---- | ---- | ---- |
| 正确率 | 100%     | 47%  | 28%  | 58%  |

书籍挡的比较扎实，人体可能因为形状不规则，有更多的声波可以投过。


## 验收

在 `check` 文件夹下。

## 难点

+ 在利用 4-bit 的 GFSK ，信号长度为 25ms 调制时，我们的 100 字符的信号只需要 6s 的音频就可以完成编码
+ 使用了两种方式互相验证的寻找数据头的方法，保证了解码的准确性
+ 使用了两种方式互相验证的解调方法，可以在干扰较小的情况下，保证解调的准确性
+ 为了避免音频突然结束出现爆鸣，我们在得到调制器的结果后，在前后均加上了若干个信号的静音
+ 为了避免频率突变出现异响，我们在调制的时候，对频率的时间序列进行了高斯滤波，得到更平滑的信号
